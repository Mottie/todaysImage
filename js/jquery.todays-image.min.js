/*
* todaysImage v1.1
* By Rob Garrison (aka Mottie & Fudgey)
* Dual licensed under the MIT and GPL licenses.
*/

(function(c){c.todaysImage=function(h,l){var a=this,b;a.el=h;a.$el=c(h);a.$el.data("todaysImage",a);a.init=function(){a.options=b=c.extend({},c.todaysImage.defaultOptions,l);var d,e,f=b.debug?new Date(b.defaultDate):new Date;a.today={m:f.getMonth()+1,d:f.getDate(),y:f.getFullYear()};a.currentImages=[];a.defaultImages=[];e=window.location.hash;if(e.match("#debug")&&!b.locked){b.debug=true;if(d=e.match(/^#debug:(0?[1-9]|[0][1-9]|[1,2][0-9]|3[0,1])[\-\/.](0?[1-9]|1[0,1,2])[\-\/.]([1|2]\d{3})$/))a.today= {m:d[2],d:d[1],y:d[3]};if((d=e.match(/^#debug:(0?[1-9]|1[0,1,2])[\-\/.]([1-9]|[0][1-9]|[1,2][0-9]|3[0,1])[\-\/.]([1|2]\d{3})$/))&&b.monthFirst)a.today={m:d[1],d:d[2],y:d[3]};if(d=e.match(/^#debug:(0?[1|2]\d{3})[\-\/.](0?[1-9]|1[0,1,2])[\-\/.]([1-9]|[0][1-9]|[1,2][0-9]|3[0,1])$/))a.today={m:d[2],d:d[3],y:d[1]}}if(b.debug){if(!a.debug)a.debug=c('<div id="todaysimage-debug"></div>');d=b.monthFirst?a.today.m+"/"+a.today.d:a.today.d+"/"+a.today.m;a.debug.html("Date used: "+d+"/"+a.today.y+"<br>")}a.endsNextYear= false;e=b.dataObject;if(c.fn.isPrototypeOf(b.data))d=[],b.data.each(function(){var a=e[0]==="text"||e[0]==="html"?c(this)[e[0]]():c(this).attr(e[0]),b=e[1]==="text"||e[1]==="html"?c(this)[e[1]]():c(this).attr(e[1]),f=e[2]==="text"||e[2]==="html"?c(this)[e[2]]():c(this).attr(e[2]);d.push([a,b,f])}),b.data=d,b.dataObject=[0,1,2];c.each(b.data,function(e){var c,f,g=b.data[e][b.dataObject[0]].replace(/\s/,"");c=b.monthFirst?0:1;f=b.monthFirst?1:0;var i=g.split("-"),g=parseInt(i[0].split("/")[c],10),j= typeof i[1]==="undefined"?g:parseInt(i[1].split("/")[c],10);g>j&&(a.today.m>=g||a.today.m<=j)?(g=g===a.today.m?a.today.m:a.today.m-1,j=j===a.today.m?a.today.m:a.today.m+1,a.endsNextYear=true):a.endsNextYear=false;if(g<=a.today.m&&j>=a.today.m)c=a.extractDay(i[0].split("/")[f]),a.today.y=a.endsNextYear?a.today.y+1:a.today.y,f=typeof i[1]==="undefined"?c:a.extractDay(i[1].split("/")[f]),g<a.today.m&&(c=1),j>a.today.m&&(f=31),b.debug&&(d=b.monthFirst?a.today.m+"/"+c+"-"+a.today.m+"/"+f:c+"/"+a.today.m+ "-"+f+"/"+a.today.m,a.debug.append("("+b.data[e][b.dataObject[0]]+"), derived range: "+d+" ")),a.today.d>=c&&a.today.d<=f?(b.debug&&a.debug.append('<span class="inRange">is in range</span>; image = '+b.data[e][b.dataObject[1]]+"<br>"),a.currentImages.push(e)):b.debug&&a.debug.append('is <span class="notInRange">NOT in range</span>; image = '+b.data[e][b.dataObject[1]]+"<br>");parseInt(b.data[e][b.dataObject[0]].split("/")[0],10)===0&&a.defaultImages.push(e)});if(a.currentImages.length===0)a.currentImages= a.defaultImages,b.debug&&a.debug.append('<br><span class="notInRange">No matches found for date range, <strong>using default Images</strong>!</span><br>');b.debug&&a.debug.append("<br><button>Show All Images</button>").find("button").click(function(){return a.showAll()});b.imagesInRange=a.currentImages;a.showImage(Math.floor(Math.random()*a.currentImages.length))};a.showImage=function(d){a.currentImages=b.imagesInRange;d%=a.currentImages.length;var e=[b.data[a.currentImages[d]][b.dataObject[0]],b.data[a.currentImages[d]][b.dataObject[1]], b.data[a.currentImages[d]][b.dataObject[2]]];a.$el.html(b.content.replace(/\{url\}/g,e[1]).replace(/\{comment\}/g,e[2]));c.data(a.el,"currentImage",e);b.debug&&a.debug.find("div").html("<br># of currentImages = "+a.currentImages.length+"<br>current random image = "+b.data[a.currentImages[d]][b.dataObject[1]]).end().appendTo(a.$el)};a.extractDay=function(d){if(!d.match(b.dayEndings+"|"+b.dayLast))return parseInt(d,10);var e,c,k,h=false;d.match(b.dayLast)&&(d="4 "+d.substring(4,d.length),h=true);c= d.substring(3,6).toLowerCase();d=parseInt(d.substring(0,1),10);for(e=k=0;e<b.dayWeek.length;e++)b.dayWeek[e].toLowerCase()===c&&(k=e);c=(new Date(a.today.y,a.today.m-1,1)).getDay();c=(d-1)*7+(k<c?k+(7-c):k+(7-c)-7)+1;h&&c+7<=30&&(c+=7);return c};a.showAll=function(){if(!a.debug)a.debug=c('<div id="todaysimage-debug"></div>').appendTo(a.$el);var d="<br><br>Showing "+b.data.length+' images<br><br><div id="todays-image-debug-thumbnails">';c.each(b.data,function(a){d+=' <img src="'+b.data[a][b.dataObject[1]]+ '" alt="'+b.data[a][b.dataObject[1]]+'" title="'+b.data[a][b.dataObject[2]].replace(/\"/g,"&quot;")+'" />'});a.debug.append(d);return false};a.currentImage=function(b){typeof b!=="undefined"&&a.showImage(b);return c.data(a.el,"currentImage")};a.randomImage=function(){a.showImage(Math.floor(Math.random()*b.imagesInRange.length));return c.data(a.el,"currentImage")};a.currentNumber=function(){return b.imagesInRange.length};a.init()};c.todaysImage.defaultOptions={data:"",dataObject:["dates","image","comment"], content:'<img src="{url}" title="{comment}" alt="{url}"><p class="comment">{comment}</p>',dayEndings:"st|nd|rd|th",dayLast:"last",dayWeek:"sun,mon,tue,wed,thu,fri,sat".split(","),monthFirst:true,locked:true,debug:false,defaultDate:"12/25/2011"};c.fn.todaysImage=function(h){return this.each(function(){new c.todaysImage(this,h)})};c.fn.gettodaysImage=function(){return this.data("todaysImage")}})(jQuery);
