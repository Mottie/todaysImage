/*
* jQuery todaysImage plug-in
* todaysImage is currently available for use in all personal or commercial 
* projects under both MIT and GPL licenses.
*
* <http://wowmotty.blogspot.com>
* @v1.0     - 07-04-2010 (major overhaul of code & renaming of plugin)
* @v0.9beta - 12-01-2009
* @author      Rob G <wowmotty@gmail.com>
*/

(function($){$.todaysImage=function(n,r){var a=this;if(n.tagName=="IMG"){a.$el=$(n);a.el=n;a.$el.data("todaysImage",a);a.init=function(){a.options=$.extend({},$.todaysImage.defaultOptions,r);var b,d=[],o=[],e=a.options.debug?new Date(a.options.defaultDate):new Date,c={m:e.getMonth()+1,d:e.getDate(),y:e.getFullYear()};e=window.location.hash;if(e.match("#debug")&&!a.options.locked){a.options.debug=true;if(a.options.monthFirst){if(b=e.match(/^#debug:(0?[\d]|1[0,1,2])[\- \/.]([0-9]|[0,1,2][0-9]|3[0,1])[\- \/.]((19|20)[0-9][0-9])$/))c=
{m:b[1],d:b[2],y:b[3]}}else if(b=e.match(/^#debug:([0-9]|[0,1,2][0-9]|3[0,1])[\- \/.](0?[\d]|1[0,1,2])[\- \/.]((19|20)[0-9][0-9])$/))c={d:b[1],m:b[2],y:b[3]}}if(a.options.debug){$("#"+a.options.debugId).length||$(a.options.debugElement).append('<div id="'+a.options.debugId+'"></div>');b=a.options.monthFirst?c.m+"/"+c.d:c.d+"/"+c.m;$("#"+a.options.debugId).html("Date used: "+b+"/"+c.y+"<br>")}var j=false,f=a.options.dataObject;if($.fn.isPrototypeOf(a.options.data)){var q=[];a.options.data.map(function(){var i=
f[0]=="text"||f[0]=="html"?$(this)[f[0]]():$(this).attr(f[0]),g=f[1]=="text"||f[1]=="html"?$(this)[f[1]]():$(this).attr(f[1]),h=f[2]=="text"||f[2]=="html"?$(this)[f[2]]():$(this).attr(f[2]);q.push([i,g,h])});a.options.data=q;a.options.dataObject=[0,1,2]}$.each(a.options.data,function(i){var g=a.options.data[i][a.options.dataObject[0]].replace(/\s/,""),h=a.options.monthFirst?0:1,l=a.options.monthFirst?1:0,m=g.split("-");g=parseInt(m[0].split("/")[h],10);h=typeof m[1]=="undefined"?g:parseInt(m[1].split("/")[h],
10);if(g>h&&(c.m>=g||c.m<=h)){g=g==c.m?c.m:c.m-1;h=h==c.m?c.m:c.m+1;j=true}else j=false;if(g<=c.m&&h>=c.m){var p=a.extractDay(m[0].split("/")[l],c);c.y=j?c.y+1:c.y;l=typeof m[1]=="undefined"?p:a.extractDay(m[1].split("/")[l],c);if(g<c.m)p=1;if(h>c.m)l=31;if(a.options.debug){b=a.options.monthFirst?c.m+"/"+p+"-"+c.m+"/"+l:p+"/"+c.m+"-"+l+"/"+c.m;$("#"+a.options.debugId).append("("+a.options.data[i][a.options.dataObject[0]]+"), derived range: "+b+" ")}if(c.d>=p&&c.d<=l){a.options.debug&&$("#"+a.options.debugId).append('<span style="color:'+
a.options.inRangeColor+'">is in range</span>; image = '+a.options.data[i][a.options.dataObject[1]]+"<br>");d.push(i)}else a.options.debug&&$("#"+a.options.debugId).append('is <span style="color:'+a.options.notInRangeColor+'">NOT in range</span>; image = '+a.options.data[i][a.options.dataObject[1]]+"<br>")}parseInt(a.options.data[i][a.options.dataObject[0]].split("/")[0],10)===0&&o.push(i)});if(d.length===0){d=o;a.options.debug&&$("#"+a.options.debugId).append('<br><span style="color:'+a.options.inRangeColor+
'">No matches found for date range, using default Images!</span>')}if(a.options.debug){$("#"+a.options.debugId).append("<br><button>Show All Images</button><br><div></div>");$("#"+a.options.debugId+" button").click(function(){a.showAll()})}a.options.imagesInRange=d;a.showImage(Math.floor(Math.random()*d.length))};a.showImage=function(b){var d=a.options.imagesInRange;b%=d.length;a.options.debug&&$("#"+a.options.debugId+" div").html("<br># of currentImages = "+d.length+"<br>current random image = "+
a.options.data[d[b]][a.options.dataObject[1]]);b=[a.options.data[d[b]][a.options.dataObject[0]],a.options.data[d[b]][a.options.dataObject[1]],a.options.data[d[b]][a.options.dataObject[2]].replace(/\"/g,"&quot;")];a.$el.attr({src:b[1],title:a.options.noImageTitle?"":b[2]});$(a.options.comment).html(b[2]);a.$el.data("currentImage",b)};a.extractDay=function(b,d){if(!b.match(a.options.dayEndings+a.options.dayLast))return parseInt(b,10);var o=false;if(b.match(a.options.dayLast)){b="4  "+b.substring(4,
b.length);o=true}var e=b.substring(3,6).toLowerCase(),c=parseInt(b.substring(0,1),10),j=0;for(k=0;k<a.options.dayWeek.length;k++)if(a.options.dayWeek[k].toLowerCase()==e)j=k;e=(new Date(d.y,d.m-1,1)).getDay();c=(c-1)*7+(j<e?j+(7-e):j+(7-e)-7)+1;if(o&&c+7<=30)c+=7;return c};a.showAll=function(){var b="<br><br>Showing "+a.options.data.length+' images<br><br><div id="thumbnails">';$.each(a.options.data,function(d){b+=' <img src="'+a.options.data[d][a.options.dataObject[1]]+'" alt="'+a.options.data[d][a.options.dataObject[1]]+
'" title="'+a.options.data[d][a.options.dataObject[2]].replace(/\"/g,"&quot;")+'" />'});$(a.options.debugElement).append(b)};a.currentImage=function(b){typeof b!=="undefined"&&a.showImage(b);return a.$el.data("currentImage")};a.randomImage=function(){a.showImage(Math.floor(Math.random()*a.options.imagesInRange.length));return a.$el.data("currentImage")};a.currentNumber=function(){return a.options.imagesInRange.length};a.init()}};$.todaysImage.defaultOptions={data:"",dataObject:["dates","image","comment"],
comment:".imageComment",noImageTitle:false,dayEndings:"st|nd|rd|th",dayLast:"last",dayWeek:["sun","mon","tue","wed","thu","fri","sat"],monthFirst:true,locked:false,debug:false,debugId:"imagedebug",debugElement:"body",defaultDate:"1/1/2010",inRangeColor:"#080",notInRangeColor:"#f00"};$.fn.todaysImage=function(n){return this.each(function(){new $.todaysImage(this,n)})};$.fn.gettodaysImage=function(){this.data("todaysImage")}})(jQuery);
